<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Leituras IoT — pública</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --space: 12px; --space2: 16px; --maxw: 1100px; }
    * { box-sizing: border-box; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; color: #111; }
    header { padding: 24px 12px 8px; }
    h1 { margin: 0 0 6px 0; font-size: 26px; }
    .muted { color:#666; font-size: 12px; }

    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 0 12px 24px; overflow-x: hidden; }

    .bar { display:flex; gap:8px; align-items:center; flex-wrap: wrap; margin: 12px 0; }
    input, select, button { padding:8px; font-size: 14px; }
    #status { margin-left: 6px; }

    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#222; color:#fff; position: sticky; top: 0; z-index: 1; }

    /* Área de gráficos */
    .grid { display:grid; grid-template-columns: 1fr; gap: var(--space2); margin: 18px 0; }
    /* Se quiser lado a lado em telas muito largas, habilite o @media abaixo */
    @media (min-width: 1400px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
    .chartbox { border:1px solid #eee; border-radius:8px; padding: var(--space); background:#fafafa; }
    .chartbox h3 { margin: 0 0 8px 0; font-size:16px; }
    .canvaswrap { position: relative; width: 100%; height: 320px; }
    canvas { width: 100% !important; height: 100% !important; display: block; }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Leituras IoT</h1>
    <div class="muted">Fonte: Supabase REST (RLS + anon key)</div>
  </header>

  <main class="wrap">
    <!-- Controles -->
    <div class="bar">
      <label for="device">Dispositivo:</label>
      <input id="device" placeholder="ex.: placa1" value="placa1" />
      <label for="limit">Limite:</label>
      <select id="limit">
        <option>50</option>
        <option selected>200</option>
        <option>500</option>
        <option>1000</option>
      </select>
      <button id="refresh">Atualizar</button>
      <button id="download">Baixar CSV</button>
      <span id="status" class="muted"></span>
    </div>

    <!-- Gráficos -->
    <section class="grid">
      <div class="chartbox">
        <h3>Temperatura (°C)</h3>
        <div class="canvaswrap"><canvas id="tempChart"></canvas></div>
      </div>

      <div class="chartbox">
        <h3>Umidade (%)</h3>
        <div class="canvaswrap"><canvas id="humChart"></canvas></div>
      </div>
    </section>

    <!-- Tabela -->
    <table id="tbl">
      <thead>
        <tr>
          <th>ID</th>
          <th>Device</th>
          <th>TS (local do navegador)</th>
          <th>Temp (°C)</th>
          <th>Umidade (%)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

<script>
/*** >>> SUBSTITUA AQUI PELOS SEUS VALORES <<< ***/
const SUPA_URL = 'https://hafzqoedrlllilclmooo.supabase.co';
const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhZnpxb2VkcmxsbGlsY2xtb29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNTgxNDYsImV4cCI6MjA3NzczNDE0Nn0.h00s3ujCRrHivvAiDBFhte5ISGitHd0JE5lDaMuo50E';

/*** Configurações ***/
const VIEW_NAME = 'readings_public';  // view com ts_local
const BASE = `${SUPA_URL}/rest/v1/${VIEW_NAME}`;
const MAX_POINTS = 200;               // pontos no gráfico (corte para mobile)

/*** DOM ***/
const statusEl = document.getElementById('status');
const deviceEl = document.getElementById('device');
const limitEl  = document.getElementById('limit');
const tbody    = document.querySelector('#tbl tbody');

/*** Utils ***/
function setStatus(msg){ statusEl.textContent = msg; }

function asCSV(rows){
  if(!rows.length) return '';
  const cols = Object.keys(rows[0]);
  const esc = v => (v==null ? '' : String(v).replaceAll('"','""'));
  const head = cols.map(c=>`"${esc(c)}"`).join(',');
  const body = rows.map(r => cols.map(c=>`"${esc(r[c])}"`).join(',')).join('\n');
  return head + '\n' + body;
}

/*** Charts ***/
let tempChart, humChart;

function makeLineChart(ctx, ylabel, labels, series){
  const dpr = Math.min(window.devicePixelRatio || 1, 1.5); // menos memória

  return new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: ylabel,
        data: series,
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.25
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, // respeita altura do contêiner
      animation: false,
      interaction: { mode:'nearest', intersect:false },
      parsing: false,
      normalized: true,
      devicePixelRatio: dpr,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { maxRotation: 0, autoSkip: true } },
        y: { beginAtZero: false }
      }
    }
  });
}

function updateCharts(rows){
  // rows chegam do mais recente para o mais antigo — vamos inverter
  const labels = rows.map(r => r.ts_local ? new Date(r.ts_local).toLocaleString() : '').reverse();
  const temps  = rows.map(r => r.temperature_c).reverse();
  const hums   = rows.map(r => r.humidity_pct).reverse();

  // corta para não sobrecarregar
  const cut = Math.max(0, labels.length - MAX_POINTS);
  if (cut > 0) {
    labels.splice(0, cut);
    temps.splice(0, cut);
    hums.splice(0, cut);
  }

  const ctxT = document.getElementById('tempChart').getContext('2d');
  const ctxH = document.getElementById('humChart').getContext('2d');

  if (!tempChart) tempChart = makeLineChart(ctxT, 'Temperatura (°C)', labels, temps);
  else { tempChart.data.labels = labels; tempChart.data.datasets[0].data = temps; tempChart.update('none'); }

  if (!humChart) humChart = makeLineChart(ctxH, 'Umidade (%)', labels, hums);
  else { humChart.data.labels = labels; humChart.data.datasets[0].data = hums; humChart.update('none'); }
}

/*** Tabela ***/
function renderTable(rows){
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    const when = r.ts_local ? new Date(r.ts_local).toLocaleString() : '';
    tr.innerHTML = `
      <td>${r.id ?? ''}</td>
      <td>${r.device_id ?? ''}</td>
      <td>${when}</td>
      <td>${r.temperature_c ?? ''}</td>
      <td>${r.humidity_pct ?? ''}</td>`;
    tbody.appendChild(tr);
  });
}

/*** Data loader ***/
async function loadData(){
  try{
    setStatus('Carregando...');
    const params = new URLSearchParams();
    params.set('select','id,device_id,ts_local,temperature_c,humidity_pct');

    const device = deviceEl.value.trim();
    if (device) params.set('device_id','eq.'+device);

    params.set('order','ts_local.desc');
    params.set('limit', limitEl.value);

    const url = `${BASE}?${params.toString()}`;
    const res = await fetch(url, {
      headers: {
        'apikey': ANON_KEY,
        'Authorization': 'Bearer ' + ANON_KEY,
        'Accept': 'application/json'
      },
      // evita cache agressivo de alguns proxies/CDNs
      cache: 'no-store'
    });

    if (!res.ok){
      setStatus(`Erro ${res.status}`);
      alert(`Erro ${res.status} ao buscar dados`);
      return;
    }

    const rows = await res.json();
    renderTable(rows);
    updateCharts(rows);
    setStatus(`Carregado: ${rows.length} registro(s).`);
    return rows;

  } catch(err){
    console.error(err);
    setStatus('Erro ao carregar');
    alert('Falha ao carregar os dados.');
  }
}

/*** Eventos ***/
document.getElementById('refresh').addEventListener('click', loadData);
document.getElementById('download').addEventListener('click', async ()=>{
  const rows = await loadData();
  if(!rows) return;
  const csv = asCSV(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'leituras.csv';
  a.click();
});

/*** Debounce de resize (evita flicker em alguns Firefox) ***/
let resizeTimer;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=>{
    if (tempChart) tempChart.resize();
    if (humChart)  humChart.resize();
  }, 150);
});

/*** Inicialização ***/
loadData();
</script>
</body>
</html>
